<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Global TLS Audit Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .page-break { 
            page-break-after: auto;       
        }
        h1, h2 { color: #2c3e50; }
        .header-block { background-color: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 5px solid #2c3e50; }
        .good { color: green; font-weight: bold; }
        .bad { color: red; font-weight: bold; }
        .warn { color: orange; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; margin-bottom: 30px;}
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .grade-A { color: green; font-weight: bold; }
        .grade-B { color: #FFA500; font-weight: bold; }
        .grade-C { color: orange; font-weight: bold; }
        .grade-F { 
            color: red; 
            font-weight: bold; 
            background: #ffe6e6; 
            padding: 2px 8px; 
            border-radius: 4px; 
    }
    </style>
</head>
<body>

<center><h1>Global TLS Security Report</h1></center>
<p><i>Generated by TLSClientAudit</i></p>

{% for report in reports %} 

<div class="page-break">
    <div class="header-block">
        <h2>Target: {{ report.server_name }}</h2>
        <p><b>Client IP:</b> {{ report.client_ip }}</p>
        <p><b>Timestamp:</b> {{ report.timestamp }}</p>
        <p><b>Final Grade:</b> 
        <span class="grade-{{ report.final_grade }}">{{ report.final_grade }}</span>
        
        {% if report.final_grade == 'F' %}
        <span style="color: red; font-size: 0.9em; margin-left: 5px;"> (CRITICAL)</span>
        {% elif report.final_grade == 'C' %}
        <span style="color: orange; font-size: 0.9em; margin-left: 5px;"> (WARNING)</span>
        {% elif report.final_grade == 'B' %}
        <span style="color: #FFA500; font-size: 0.9em; margin-left: 5px;"> (MODERATE)</span>
        {% endif %}
    </div>

    <h3>1. Passive Analysis</h3>
    <ul>
        <li>SNI: {{ report.passive.sni }}</li>
        <li>Ciphers offered: {{ report.passive.cipher_count }}</li>
        <li>Weak ciphers offered: 
            {% if report.passive.offered_weak_ciphers %}
                <span class="bad">{{ report.passive.offered_weak_ciphers | length }}</span>
                <div style="background: #fff0f0; border: 1px solid #ffcccc; padding: 10px; margin-top: 5px; margin-bottom: 10px; font-size: 0.85em; color: #a00; border-radius: 4px;">
                    <strong>List of Weak Suites:</strong><br>
                    <div style="margin-top:5px; column-count: 1; column-gap: 20px;">
                    {% for cipher in report.passive.offered_weak_ciphers %}
                        <div style="margin-bottom: 2px;">• {{ cipher }}</div>
                    {% endfor %}
                    </div>
                </div>
            {% else %}
                <span class="good">0</span>
            {% endif %}
        </li>
        <li>Forward Secrecy (PFS): 
            {% set pfs = report.negotiated.pfs | default("N/A") %}
            <span class="{{ 'good' if pfs == 'YES' else 'bad' }}">
                {{ pfs }}
            </span>
        </li>
        
        <li>Authenticated Encryption (AEAD): 
            {% set aead = report.negotiated.aead | default("N/A") %}
            <span class="{{ 'good' if aead == 'YES' else 'warn' }}">
                {{ aead }}
            </span>
        </li>
    </ul>

    <h3>2. Certificate Analysis</h3>
    <ul>
        <li>Key type: {{ report.certificate.key_type }}</li>
        <li>Key size: {{ report.certificate.key_size }} bits</li>
        <li>Signature: {{ report.certificate.signature_algorithm }}</li>
        <li>Weak key: {{ report.certificate.weak_key }}</li>
        <li>Weak signature: {{ report.certificate.weak_signature }}</li>
    </ul>

    <h3>3. Active Attacks</h3>
    <table>
        <tr>
            <th>Step</th>
            <th>Attack</th>
            <th>Details</th>
            <th>Result</th>
        </tr>
        {% for attack in report.attacks %}
        <tr>
            <td>{{ attack.step }}</td>
            <td>{{ attack.attack }}</td>
            <td>{{ attack.details }}</td>
            <td>
                {% if 'SKIPPED' in attack.details %}
                    <span class="warn">SKIPPED</span>
                {% elif attack.success %}
                    <span class="bad">VULNERABLE</span>
                {% else %}
                    <span class="good">BLOCKED</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    <p><strong>Test Coverage:</strong> 
        {% set completed = report.attacks|length %}
        {% set total = 5 %}
        {% set percentage = (completed / total * 100)|int %}
        
        {% if percentage == 100 %}
            <span style="color: green; font-weight: bold;">✓ Complete (100%)</span>
        {% elif percentage >= 80 %}
            <span style="color: #FFA500; font-weight: bold;">{{ percentage }}% ({{ 5-completed }} test(s) skipped)</span>
        {% else %}
            <span style="color: red; font-weight: bold;">{{ percentage }}% (INCOMPLETE)</span>
        {% endif %}
        </p>
    <hr>
</div>

{% endfor %} 

<div style="background: #f0f8ff; padding: 20px; border-radius: 5px; border-left: 5px solid #2c3e50; margin-bottom: 30px;">
  <h3>Executive Summary</h3>
  <p><strong>Total Connections Audited:</strong> {{ reports|length }}</p>
  <p><strong>Average Grade:</strong> 
    {% set grade_points = {'A': 4, 'B': 3, 'C': 2, 'F': 0} %}
    {% set total_score = 0 %}
    {% for report in reports %}
      {% if report.final_grade in grade_points %}
        {% set total_score = total_score + grade_points[report.final_grade] %}
      {% endif %}
    {% endfor %}
    {% if reports|length > 0 %}
      {{ (total_score / reports|length)|round(1) }}
    {% else %}
      N/A
    {% endif %}
  </p>
  <p><strong>Most Common Vulnerability:</strong> 
    {% set vuln_counter = {'TLS Downgrade': 0, 'Weak Cipher': 0, 'Expired Cert': 0, 'Weak Sig (SHA1)': 0} %}
    {% for report in reports %}
      {% for attack in report.attacks %}
        {% if attack.success %}
          {% if attack.attack in vuln_counter %}
            {% set vuln_counter = vuln_counter.update({attack.attack: vuln_counter[attack.attack] + 1}) or vuln_counter %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endfor %}
    {% set top_vuln = vuln_counter|dictsort(by='value')|last %}
    {% if top_vuln[1] > 0 %}
      {{ top_vuln[0] }} ({{ top_vuln[1] }} occurrence(s))
    {% else %}
      None detected
    {% endif %}
  </p>
</div>

</body>
</html>
